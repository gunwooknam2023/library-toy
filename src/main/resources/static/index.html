<!DOCTYPE html>
<html lang="kr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>도서</title>
<!--    <link rel="stylesheet" href="/css/index.css">-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
</head>
<body>

<button type="button" class="btn btn-dark" style="width: 140px; height: 50px; margin-left: 40%; margin-top: 20px">저장된 책 목록</button>

<div style="padding-left: 40%; padding-top: 50px; margin: 0 auto;">
    <p1 style="font-weight: bold">검색할 도서명을 입력해주세요.</p1>
    <div class="form-floating" style="width: 20%;">
        <textarea class="form-control" placeholder="Leave a comment here" id="floatingTextarea"></textarea>
        <label for="floatingTextarea">도서명</label>
    </div>
    <button type="button" class="btn btn-secondary" style="margin-top: 5px" onclick="searchBooks()">검색</button>
</div>

<div style="width: 1500px; height: 1500px; margin: 0 auto; margin-top: 30px; border: 1px solid black;">
    <ul id="searchResults"></ul>
</div>

<nav aria-label="Page navigation example">
    <ul class="pagination" id="pagination"></ul>
</nav>


<script>
    // 엔터 키를 눌렀을 때 검색 함수 호출
    document.getElementById("floatingTextarea").addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            event.preventDefault(); // 엔터 키의 기본 동작 취소
            searchBooks();
        }
    });

    function searchBooks() {
        // 도서명 입력값 가져오기
        var bookQuery = document.getElementById("floatingTextarea").value;

        // API 호출을 위한 Ajax 요청
        var xhr = new XMLHttpRequest();
        var currentPage = 1;  // 초기 페이지는 1로 설정
        xhr.open("GET", "/books?query=" + encodeURIComponent(bookQuery) + "&page=" + currentPage, true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                // API 응답을 처리하는 코드
                var response = JSON.parse(xhr.responseText);
                console.log(response); // 여기에서 응답을 활용하여 필요한 동작 수행

                // 검색 결과를 화면에 표시
                showSearchResults(response);

                // 페이지네이션 업데이트
                updatePagination(response.totalPages);

                // 검색 후 입력값 초기화
                document.getElementById("floatingTextarea").value = "";
            }
        };
        xhr.send();
    }



    // 검색 결과를 화면에 표시하는 함수
    function showSearchResults(response) {
        var searchResultsElement = document.getElementById("searchResults");
        searchResultsElement.innerHTML = ""; // 이전 검색 결과 초기화

        if (!response || !response.length || response.length === 0) {
            var noResultsMessage = document.createElement("p");
            noResultsMessage.textContent = "검색 결과가 없습니다.";
            searchResultsElement.appendChild(noResultsMessage);
            return;
        }

        response.forEach(function (item, index) {

            // 저장 버튼 추가
            var saveButton = document.createElement("button");
            saveButton.innerHTML = "저장";
            saveButton.className = "btn btn-primary";
            saveButton.style.fontSize = "15px";
            saveButton.addEventListener("click", function () {
                // 저장 요청을 서버로 보냄
                saveBook(item);
            });

            var listItem = document.createElement("li");
            listItem.style.width = "100%"; // 가로 100%로 설정
            listItem.style.height = "150px"; // 세로 150px로 설정
            listItem.style.boxSizing = "border-box"; // 요소의 크기를 콘텐츠 박스 기준으로 설정
            // listItem.style.margin = "10px"; // 간격을 적절히 조절
            listItem.style.display = "flex"; // 수평 정렬을 위해 flex 사용

            // ISBN 표시 (10%)
            var isbnElement = document.createElement("p");
            isbnElement.style.width = "10%";
            isbnElement.textContent = item.isbn;
            listItem.appendChild(isbnElement);

            // 검은색 선 추가
            var lineElement1 = document.createElement("div");
            lineElement1.style.width = "1px";
            lineElement1.style.backgroundColor = "black";
            lineElement1.style.height = "100%";
            listItem.appendChild(lineElement1);

            // Image 표시 (10%)
            var imageElement = document.createElement("img");
            imageElement.style.width = "10%";
            imageElement.src = item.image;
            imageElement.style.maxHeight = "100%"; // 이미지가 높이를 넘지 않도록 설정
            listItem.appendChild(imageElement);

            // 검은색 선 추가
            var lineElement2 = document.createElement("div");
            lineElement2.style.width = "1px";
            lineElement2.style.backgroundColor = "black";
            lineElement2.style.height = "100%";
            listItem.appendChild(lineElement2);

            // Title 및 Link 표시 (50%)
            var titleElement = document.createElement("h3");
            titleElement.style.width = "50%";
            var titleLink = document.createElement("a");
            titleLink.href = item.link;
            titleLink.textContent = item.title;
            titleElement.appendChild(titleLink);
            listItem.appendChild(titleElement);

            // 검은색 선 추가
            var lineElement3 = document.createElement("div");
            lineElement3.style.width = "1px";
            lineElement3.style.backgroundColor = "black";
            lineElement3.style.height = "100%";
            listItem.appendChild(lineElement3);

            // Discount 표시 (10%)
            var discountElement = document.createElement("p");
            discountElement.style.width = "10%";
            discountElement.textContent = item.discount;
            listItem.appendChild(discountElement);

            // 검은색 선 추가
            var lineElement4 = document.createElement("div");
            lineElement4.style.width = "1px";
            lineElement4.style.backgroundColor = "black";
            lineElement4.style.height = "100%";
            listItem.appendChild(lineElement4);

            // Author/Publisher 표시 (10%)
            var authorPublisherElement = document.createElement("p");
            authorPublisherElement.style.width = "10%";
            authorPublisherElement.innerHTML = item.author + "<br/>"+ "<br/>"+ item.publisher;
            listItem.appendChild(authorPublisherElement);

            // 검은색 선 추가
            var lineElement5 = document.createElement("div");
            lineElement5.style.width = "1px";
            lineElement5.style.backgroundColor = "black";
            lineElement5.style.height = "100%";
            listItem.appendChild(lineElement5);

            // Pubdate 표시 (10%)
            var pubdateElement = document.createElement("p");
            pubdateElement.style.width = "10%";
            pubdateElement.textContent = item.pubdate;
            listItem.appendChild(pubdateElement);

            searchResultsElement.appendChild(listItem);

            // 아래에 수평 선 추가
            if (index < response.length) {
                var horizontalLine = document.createElement("div");
                horizontalLine.style.width = "100%";
                horizontalLine.style.borderBottom = "1px solid black";
                searchResultsElement.appendChild(horizontalLine);
            }

            listItem.appendChild(saveButton);

            searchResultsElement.appendChild(listItem);
        });
    }



    // 페이지네이션을 업데이트하는 함수
    function updatePagination(totalPages) {
        var paginationElement = document.getElementById("pagination");
        paginationElement.innerHTML = ""; // 이전 페이지네이션 초기화

        // 한 번에 보여줄 페이지 수 설정
        var maxPagesToShow = 5;

        // 현재 페이지 가져오기
        var currentPage = 1;

        // 페이지네이션 생성
        for (var i = 1; i <= totalPages && i <= 100; i++) {
            // 한 번에 보여줄 페이지 수를 초과하면 더 이상 생성하지 않음
            if (i > maxPagesToShow) {
                break;
            }

            var listItem = document.createElement("li");
            listItem.className = "page-item";
            var link = document.createElement("a");
            link.className = "page-link";
            link.href = "#";
            link.textContent = i;
            link.addEventListener("click", function () {
                // 페이지 번호 클릭 시 해당 페이지로 검색 요청
                searchBooks(this.textContent);
            });
            listItem.appendChild(link);

            // 현재 페이지에 active 클래스 추가
            if (i === currentPage) {
                listItem.className += " active";
            }

            paginationElement.appendChild(listItem);
        }
    }

    // 도서 저장 요청 함수
    function saveBook(book) {
        // 서버에 저장 요청 보내는 부분
        var saveRequest = new XMLHttpRequest();
        saveRequest.open("POST", "/books", true);
        saveRequest.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        saveRequest.onreadystatechange = function () {
            if (saveRequest.readyState == 4) {
                if (saveRequest.status == 200) {
                    alert("도서 저장 완료.");
                } else {
                    alert("이미 저장된 도서입니다..");
                }
            }
        };

        // 서버에 보낼 도서 정보 설정
        var saveData = {
            isbn: book.isbn,
            // 다른 필요한 정보들도 추가할 수 있음
        };

        saveRequest.send(JSON.stringify(saveData));
    }

</script>



</body>
</html>